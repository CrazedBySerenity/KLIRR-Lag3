<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Klirr User PWA (PoC)</title>
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#0f1115" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", Arial, sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px 16px 40px;
        background: #0f1115;
        color: #f5f7fb;
      }
      .container {
        max-width: 520px;
        margin: 0 auto;
      }
      header {
        margin-bottom: 20px;
      }
      h1 {
        margin: 0 0 6px 0;
        font-size: 24px;
      }
      p {
        margin: 0;
        color: #a7b0c0;
        font-size: 14px;
      }
      .card {
        border: 1px solid #242a36;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        background: #161a22;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }
      .card h2 {
        margin: 0 0 10px 0;
        font-size: 18px;
      }
      .hint {
        color: #a7b0c0;
        font-size: 13px;
        margin-bottom: 12px;
      }
      .summary {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px 12px;
        background: #12161f;
        border-radius: 12px;
        padding: 12px;
      }
      .summary .label {
        color: #a7b0c0;
        font-size: 12px;
      }
      .summary .value {
        font-weight: 600;
        font-size: 14px;
        text-align: right;
      }
      .tx-list {
        list-style: none;
        padding: 0;
        margin: 8px 0 0 0;
      }
      .tx-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #232833;
        font-size: 14px;
      }
      .tx-item:last-child {
        border-bottom: none;
      }
      .tx-empty {
        color: #8d97aa;
        font-size: 13px;
        padding: 8px 0;
      }
      button {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid transparent;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
      }
      button.primary {
        background: #2d6cdf;
        color: #ffffff;
      }
      button.secondary {
        background: #1f2430;
        color: #f5f7fb;
        border-color: #2b3240;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .button-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      #qr {
        margin-top: 14px;
        background: #ffffff;
        padding: 8px;
        display: inline-block;
        border-radius: 12px;
      }
      .status {
        margin-top: 10px;
        font-size: 12px;
        color: #9aa3b6;
      }
      video {
        width: 100%;
        border-radius: 12px;
        background: #000000;
        margin-bottom: 12px;
      }
      canvas {
        display: none;
      }
      .hidden {
        display: none;
      }
      .footer {
        margin-top: 24px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>User</h1>
        <p>Show your QR to the vendor, then scan their response.</p>
      </header>

      <section class="card" id="stepOne">
        <h2>Step 1: Show this QR</h2>
        <div class="summary" id="summaryCurrent"></div>
        <div id="qrWrap" class="hidden">
          <div id="qr"></div>
          <div class="status" id="qrStatus"></div>
        </div>
      </section>

      <section class="card hidden" id="scanSection">
        <h2>Step 2: Scan vendor response</h2>
        <p class="hint">Point the camera at the vendor QR.</p>
        <video id="scannerVideo" playsinline></video>
        <canvas id="scannerCanvas"></canvas>
        <div class="status" id="scanStatus"></div>
      </section>

      <section class="card hidden" id="updatedSection">
        <h2>Updated quota</h2>
        <div class="summary" id="summaryUpdated"></div>
        <p class="hint">Transactions received:</p>
        <ul class="tx-list" id="historyList"></ul>
      </section>

      <section class="footer">
        <button class="primary" id="primaryAction"></button>
        <button class="secondary" id="resetDemo">Reset demo</button>
        <div class="status" id="resetStatus"></div>
      </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
      const STORAGE_KEY = "klirr_user_state_v1";
      const summaryCurrentEl = document.getElementById("summaryCurrent");
      const summaryUpdatedEl = document.getElementById("summaryUpdated");
      const historyListEl = document.getElementById("historyList");
      const qrWrapEl = document.getElementById("qrWrap");
      const stepOneEl = document.getElementById("stepOne");
      const scanSectionEl = document.getElementById("scanSection");
      const updatedSectionEl = document.getElementById("updatedSection");
      const qrStatusEl = document.getElementById("qrStatus");
      const scanStatusEl = document.getElementById("scanStatus");
      const resetStatusEl = document.getElementById("resetStatus");
      const primaryActionEl = document.getElementById("primaryAction");
      const videoEl = document.getElementById("scannerVideo");
      const canvasEl = document.getElementById("scannerCanvas");
      const canvasCtx = canvasEl.getContext("2d");

      let scanStream = null;
      let scanning = false;
      let state = null;

      const PRODUCTS = [
        { name: "Alvedon", unit: "förp" },
        { name: "Drivmedel", unit: "liter" },
        { name: "Mjöl", unit: "kg" }
      ];

      const defaultState = {
        quotaSummary: {
          quotaId: "quota-001",
          userId: "user-001",
          vendorId: "vendor-001",
          items: [
            { name: "Alvedon", unit: "förp", limit: 4, used: 1, remaining: 3 },
            { name: "Drivmedel", unit: "liter", limit: 40, used: 12, remaining: 28 },
            { name: "Mjöl", unit: "kg", limit: 5, used: 1, remaining: 4 }
          ]
        },
        pendingTransactions: [
          {
            id: "u-tx-001",
            ts: "2026-02-04T08:40:00Z",
            product: "Alvedon",
            amount: 1,
            unit: "förp",
            note: "Apoteket"
          },
          {
            id: "u-tx-002",
            ts: "2026-02-04T10:15:00Z",
            product: "Drivmedel",
            amount: 10,
            unit: "liter",
            note: "Tankning"
          }
        ],
        historyTransactions: [],
        qrGenerated: false,
        vendorApplied: false
      };

      const formatAmount = (value, unit) => `${Number(value).toFixed(1)} ${unit}`;

      const renderSummary = (el, summary) => {
        const items = summary.items || [];
        el.innerHTML = items
          .map(
            (item) => `
              <div class="label">${item.name}</div>
              <div class="value">${formatAmount(item.remaining, item.unit)} kvar</div>
            `
          )
          .join("");
      };

      const renderTransactions = (listEl, transactions) => {
        listEl.innerHTML = "";
        if (!transactions.length) {
          const item = document.createElement("li");
          item.className = "tx-empty";
          item.textContent = "No transactions.";
          listEl.appendChild(item);
          return;
        }
        transactions.forEach((tx) => {
          const item = document.createElement("li");
          item.className = "tx-item";
          item.innerHTML = `
            <span>${tx.product || "Produkt"}</span>
            <strong>${formatAmount(tx.amount, tx.unit || "st")}</strong>
          `;
          listEl.appendChild(item);
        });
      };

      const saveState = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      };

      const loadState = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          state = structuredClone(defaultState);
          saveState();
          return;
        }
        try {
          state = JSON.parse(raw);
        } catch (error) {
          state = structuredClone(defaultState);
          saveState();
        }
      };

      const renderState = () => {
        renderSummary(summaryCurrentEl, state.quotaSummary);
        renderTransactions(historyListEl, state.historyTransactions);

        qrWrapEl.classList.toggle("hidden", !state.qrGenerated);
        stepOneEl.classList.toggle("hidden", scanning || state.vendorApplied);
        scanSectionEl.classList.toggle("hidden", !scanning || state.vendorApplied);
        updatedSectionEl.classList.toggle("hidden", !state.vendorApplied);
        if (state.vendorApplied) {
          renderSummary(summaryUpdatedEl, state.quotaSummary);
        }

        if (state.vendorApplied) {
          primaryActionEl.classList.add("hidden");
        } else {
          primaryActionEl.classList.remove("hidden");
          if (!state.qrGenerated) {
            primaryActionEl.textContent = "Generate QR code";
          } else if (scanning) {
            primaryActionEl.textContent = "Stop scan";
          } else {
            primaryActionEl.textContent = "Scan vendor code";
          }
        }
      };

      const buildPayload = () => ({
        v: 1,
        f: "u",
        q: {
          r: PRODUCTS.map((product) => {
            const item = state.quotaSummary.items.find((i) => i.name === product.name);
            return item ? item.remaining : 0;
          })
        },
        t: state.pendingTransactions.map((tx) => [
          PRODUCTS.findIndex((product) => product.name === tx.product),
          tx.amount
        ])
      });

      const renderQr = (payload) => {
          const qrContainer = document.getElementById("qr");
          qrContainer.innerHTML = "";
          var qr = qrcode(0, 'L');
          qr.addData(JSON.stringify(payload));
          qr.make();
          qrContainer.innerHTML = qr.createImgTag(6);
        }

      const handleVendorPayload = (payload) => {
        if (!payload || payload.f !== "v" || payload.v !== 1) {
          scanStatusEl.textContent = "Invalid vendor payload.";
          return;
        }
        if (!payload.q || !Array.isArray(payload.q.r)) {
          scanStatusEl.textContent = "Vendor payload missing quota summary.";
          return;
        }
        state.quotaSummary = {
          ...state.quotaSummary,
          items: PRODUCTS.map((product, index) => ({
            name: product.name,
            unit: product.unit,
            remaining: payload.q.r[index] ?? 0,
            used: 0,
            limit: payload.q.r[index] ?? 0
          }))
        };
        if (Array.isArray(payload.t)) {
          state.historyTransactions.push(
            ...payload.t.map((tx) => {
              const product = PRODUCTS[tx[0]] || { name: "Produkt", unit: "st" };
              return {
                product: product.name,
                amount: tx[1],
                unit: product.unit,
                source: "vendor"
              };
            })
          );
        }
        state.pendingTransactions = [];
        state.vendorApplied = true;
        saveState();
        renderState();
        scanStatusEl.textContent = "Vendor QR applied.";
      };

      const startScan = async () => {
        scanStatusEl.textContent = "Starting camera...";
        try {
          scanStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
          });
          videoEl.srcObject = scanStream;
          await videoEl.play();
          scanning = true;
          renderState();
          scanLoop();
        } catch (error) {
          scanStatusEl.textContent = "Camera access blocked or unavailable.";
        }
      };

      const stopScan = () => {
        scanning = false;
        if (scanStream) {
          scanStream.getTracks().forEach((track) => track.stop());
          scanStream = null;
        }
        videoEl.pause();
        videoEl.srcObject = null;
        renderState();
      };

      const scanLoop = () => {
        if (!scanning) return;
        if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
          canvasEl.width = videoEl.videoWidth;
          canvasEl.height = videoEl.videoHeight;
          canvasCtx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
          const imageData = canvasCtx.getImageData(0, 0, canvasEl.width, canvasEl.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert"
          });
          if (code && code.data) {
            stopScan();
            scanStatusEl.textContent = "QR detected.";
            try {
              const payload = JSON.parse(code.data);
              handleVendorPayload(payload);
            } catch (error) {
              scanStatusEl.textContent = "QR payload is not valid JSON.";
            }
            return;
          }
        }
        requestAnimationFrame(scanLoop);
      };

      primaryActionEl.addEventListener("click", () => {
        if (!state.qrGenerated) {
          const payload = buildPayload();
          renderQr(payload);
          state.qrGenerated = true;
          saveState();
          renderState();
          qrStatusEl.textContent = "QR ready. Show this to the vendor.";
          return;
        }
        if (scanning) {
          stopScan();
          scanStatusEl.textContent = "Scan stopped.";
          return;
        }
        startScan();
      });
      document.getElementById("resetDemo").addEventListener("click", () => {
        state = structuredClone(defaultState);
        saveState();
        renderState();
        resetStatusEl.textContent = "Demo reset.";
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js");
      }

      loadState();
      renderState();
    </script>
  </body>
</html>
