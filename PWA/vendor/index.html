<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Klirr Vendor PWA (PoC)</title>
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#0f111a" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", Arial, sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px 16px 40px;
        background: #0f111a;
        color: #f5f7fb;
      }
      .container {
        max-width: 520px;
        margin: 0 auto;
      }
      header {
        margin-bottom: 20px;
      }
      h1 {
        margin: 0 0 6px 0;
        font-size: 24px;
      }
      p {
        margin: 0;
        color: #a7b0c0;
        font-size: 14px;
      }
      .card {
        border: 1px solid #242a36;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        background: #161a26;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }
      .card h2 {
        margin: 0 0 10px 0;
        font-size: 18px;
      }
      .hint {
        color: #a7b0c0;
        font-size: 13px;
        margin-bottom: 12px;
      }
      .summary {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px 12px;
        background: #121624;
        border-radius: 12px;
        padding: 12px;
      }
      .summary .label {
        color: #a7b0c0;
        font-size: 12px;
      }
      .summary .value {
        font-weight: 600;
        font-size: 14px;
        text-align: right;
      }
      .tx-list {
        list-style: none;
        padding: 0;
        margin: 8px 0 0 0;
      }
      .tx-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #232833;
        font-size: 14px;
      }
      .tx-item:last-child {
        border-bottom: none;
      }
      .tx-empty {
        color: #8d97aa;
        font-size: 13px;
        padding: 8px 0;
      }
      button {
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 1px solid transparent;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
      }
      button.primary {
        background: #4a7aff;
        color: #ffffff;
      }
      button.secondary {
        background: #1f2430;
        color: #f5f7fb;
        border-color: #2b3240;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .button-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      #qr {
        margin-top: 14px;
        background: #ffffff;
        padding: 8px;
        display: inline-block;
        border-radius: 12px;
      }
      .status {
        margin-top: 10px;
        font-size: 12px;
        color: #9aa3b6;
      }
      video {
        width: 100%;
        border-radius: 12px;
        background: #000000;
        margin-bottom: 12px;
      }
      canvas {
        display: none;
      }
      .hidden {
        display: none;
      }
      .footer {
        margin-top: 24px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Vendor</h1>
        <p>Scan the user QR, then show the response QR back.</p>
      </header>

      <section class="card" id="scanSection">
        <h2>Step 1: Scan user QR</h2>
        <p class="hint">Point the camera at the user QR.</p>
        <video id="scannerVideo" playsinline></video>
        <canvas id="scannerCanvas"></canvas>
        <div class="button-row">
          <button class="secondary" id="startScan">Start Scan</button>
          <button class="secondary" id="stopScan" disabled>Stop Scan</button>
        </div>
        <div class="status" id="scanStatus"></div>
      </section>

      <section class="card hidden" id="userSection">
        <h2>User quota</h2>
        <div class="summary" id="userSummary"></div>
        <p class="hint">Transactions from user:</p>
        <ul class="tx-list" id="userTxList"></ul>
      </section>

      <section class="card hidden" id="vendorSection">
        <h2>Vendor transactions</h2>
        <p class="hint">Prefilled for demo:</p>
        <ul class="tx-list" id="vendorTxList"></ul>
        <button class="primary" id="generateQr">Generate response QR</button>
        <div class="status" id="qrStatus"></div>
      </section>

      <section class="card hidden" id="qrSection">
        <h2>Show this to the user</h2>
        <div id="qr"></div>
        <div class="status">User should scan this QR to update.</div>
      </section>

      <section class="footer">
        <button class="secondary" id="resetDemo">Reset demo</button>
        <div class="status" id="resetStatus"></div>
      </section>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <script>
      const STORAGE_KEY = "klirr_vendor_state_v1";
      const userSummaryEl = document.getElementById("userSummary");
      const userTxListEl = document.getElementById("userTxList");
      const vendorTxListEl = document.getElementById("vendorTxList");
      const scanStatusEl = document.getElementById("scanStatus");
      const qrStatusEl = document.getElementById("qrStatus");
      const resetStatusEl = document.getElementById("resetStatus");
      const scanSectionEl = document.getElementById("scanSection");
      const userSectionEl = document.getElementById("userSection");
      const vendorSectionEl = document.getElementById("vendorSection");
      const qrSectionEl = document.getElementById("qrSection");
      const videoEl = document.getElementById("scannerVideo");
      const canvasEl = document.getElementById("scannerCanvas");
      const canvasCtx = canvasEl.getContext("2d");

      let scanStream = null;
      let scanning = false;
      let state = null;

      const PRODUCTS = [
        { name: "Alvedon", unit: "förp" },
        { name: "Drivmedel", unit: "liter" },
        { name: "Mjöl", unit: "kg" }
      ];

      const defaultState = {
        lastScannedUserPayload: null,
        vendorTransactions: [
          {
            id: "v-tx-001",
            ts: "2026-02-04T10:50:00Z",
            product: "Mjöl",
            amount: 1,
            unit: "kg",
            note: "Matbutik"
          },
          {
            id: "v-tx-002",
            ts: "2026-02-04T11:15:00Z",
            product: "Alvedon",
            amount: 1,
            unit: "förp",
            note: "Apoteket"
          }
        ],
        qrGenerated: false
      };

      const formatAmount = (value, unit) => `${Number(value).toFixed(1)} ${unit}`;

      const renderSummary = (el, summary) => {
        const items = summary.items || [];
        el.innerHTML = items
          .map(
            (item) => `
              <div class="label">${item.name}</div>
              <div class="value">${formatAmount(item.remaining, item.unit)} kvar</div>
            `
          )
          .join("");
      };

      const renderTransactions = (listEl, transactions) => {
        listEl.innerHTML = "";
        if (!transactions.length) {
          const item = document.createElement("li");
          item.className = "tx-empty";
          item.textContent = "No transactions.";
          listEl.appendChild(item);
          return;
        }
        transactions.forEach((tx) => {
          const item = document.createElement("li");
          item.className = "tx-item";
          item.innerHTML = `
            <span>${tx.product || "Produkt"}</span>
            <strong>${formatAmount(tx.amount, tx.unit || "st")}</strong>
          `;
          listEl.appendChild(item);
        });
      };

      const saveState = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      };

      const loadState = () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          state = structuredClone(defaultState);
          saveState();
          return;
        }
        try {
          state = JSON.parse(raw);
        } catch (error) {
          state = structuredClone(defaultState);
          saveState();
        }
      };

      const buildUpdatedSummary = (payload) => {
        const summary = payload.q || {};
        const remaining = Array.isArray(summary.r) ? [...summary.r] : PRODUCTS.map(() => 0);
        const transactions = Array.isArray(payload.t) ? payload.t : [];

        transactions.forEach((tx) => {
          const index = Number(tx[0]);
          const amount = Number(tx[1]) || 0;
          if (Number.isNaN(index) || index < 0 || index >= remaining.length) return;
          remaining[index] = Math.max(0, (Number(remaining[index]) || 0) - amount);
        });

        return { r: remaining };
      };

      const buildResponsePayload = () => {
        const userPayload = state.lastScannedUserPayload;
        if (!userPayload || !userPayload.q) return null;
        const summary = buildUpdatedSummary(userPayload);
        return {
          v: 1,
          f: "v",
          q: summary,
          t: state.vendorTransactions.map((tx) => [
            PRODUCTS.findIndex((product) => product.name === tx.product),
            tx.amount
          ])
        };
      };

      const renderQr = (payload) => {
          const qrContainer = document.getElementById("qr");
          qrContainer.innerHTML = "";
          var qr = qrcode(0, 'L');
          qr.addData(JSON.stringify(payload));
          qr.make();
          qrContainer.innerHTML = qr.createImgTag(6);
        }

      const renderState = () => {
        const hasUser = Boolean(state.lastScannedUserPayload);
        scanSectionEl.classList.toggle("hidden", false);
        userSectionEl.classList.toggle("hidden", !hasUser);
        vendorSectionEl.classList.toggle("hidden", !hasUser);
        qrSectionEl.classList.toggle("hidden", !state.qrGenerated);

        renderTransactions(vendorTxListEl, state.vendorTransactions);

        if (hasUser) {
          const payload = state.lastScannedUserPayload;
          const summary = payload.q || {};
          renderSummary(userSummaryEl, {
            items: (summary.r || []).map((remaining, index) => ({
              name: PRODUCTS[index]?.name || "Produkt",
              unit: PRODUCTS[index]?.unit || "st",
              remaining
            }))
          });
          renderTransactions(
            userTxListEl,
            (payload.t || []).map((tx) => ({
              product: PRODUCTS[tx[0]]?.name || "Produkt",
              amount: tx[1],
              unit: PRODUCTS[tx[0]]?.unit || "st"
            }))
          );
        }
      };

      const handleUserPayload = (payload) => {
        if (!payload || payload.f !== "u" || payload.v !== 1) {
          scanStatusEl.textContent = "Invalid user payload.";
          return;
        }
        if (!payload.q || !Array.isArray(payload.q.r)) {
          scanStatusEl.textContent = "User payload missing quota summary.";
          return;
        }
        state.lastScannedUserPayload = payload;
        state.qrGenerated = false;
        saveState();
        renderState();
        scanStatusEl.textContent = "User QR captured.";
      };

      const startScan = async () => {
        scanStatusEl.textContent = "Starting camera...";
        try {
          scanStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
          });
          videoEl.srcObject = scanStream;
          await videoEl.play();
          scanning = true;
          document.getElementById("startScan").disabled = true;
          document.getElementById("stopScan").disabled = false;
          scanLoop();
        } catch (error) {
          scanStatusEl.textContent = "Camera access blocked or unavailable.";
        }
      };

      const stopScan = () => {
        scanning = false;
        if (scanStream) {
          scanStream.getTracks().forEach((track) => track.stop());
          scanStream = null;
        }
        videoEl.pause();
        videoEl.srcObject = null;
        document.getElementById("startScan").disabled = false;
        document.getElementById("stopScan").disabled = true;
      };

      const scanLoop = () => {
        if (!scanning) return;
        if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
          canvasEl.width = videoEl.videoWidth;
          canvasEl.height = videoEl.videoHeight;
          canvasCtx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
          const imageData = canvasCtx.getImageData(0, 0, canvasEl.width, canvasEl.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert"
          });
          if (code && code.data) {
            stopScan();
            scanStatusEl.textContent = "QR detected.";
            try {
              const payload = JSON.parse(code.data);
              handleUserPayload(payload);
            } catch (error) {
              scanStatusEl.textContent = "QR payload is not valid JSON.";
            }
            return;
          }
        }
        requestAnimationFrame(scanLoop);
      };

      document.getElementById("generateQr").addEventListener("click", () => {
        const payload = buildResponsePayload();
        if (!payload) {
          qrStatusEl.textContent = "Scan a user QR first.";
          return;
        }
        renderQr(payload);
        state.qrGenerated = true;
        saveState();
        renderState();
        qrStatusEl.textContent = "Response QR ready.";
      });
      document.getElementById("startScan").addEventListener("click", startScan);
      document.getElementById("stopScan").addEventListener("click", stopScan);
      document.getElementById("resetDemo").addEventListener("click", () => {
        state = structuredClone(defaultState);
        saveState();
        renderState();
        resetStatusEl.textContent = "Demo reset.";
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js");
      }

      loadState();
      renderState();
    </script>
  </body>
</html>
